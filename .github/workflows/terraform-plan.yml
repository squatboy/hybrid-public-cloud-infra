name: terraform-plan.yml

on:
  pull_request:
    types: [opened, synchronize, reopened]
  push:
    branches:
      - main

permissions:
  contents: read
  pull-requests: write
  security-events: write

env:
  TF_VERSION: 1.6.0
  AWS_REGION: ap-northeast-2

jobs:
  terraform-validate:
    name: Validate & Format Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Terraform Format Check
        run: |
          terraform fmt -check -recursive
        continue-on-error: true

      - name: Terraform Validate
        run: |
          terraform init -backend=false
          terraform validate
        env:
          AWS_REGION: ${{ env.AWS_REGION }}

      - name: Upload validation result
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: validation-result
          path: .

  tflint-scan:
    name: TFLint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup TFLint
        uses: terraform-linters/setup-tflint@v3
        with:
          tflint_version: latest

      - name: Init TFLint
        run: |
          tflint --init

      - name: Run TFLint
        run: |
          tflint --format compact --recursive .
        continue-on-error: true

  security-scan:
    name: Security Scan (Trivy)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Trivy scan
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'config'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'
        continue-on-error: true

      - name: Upload Trivy results
        uses: github/codeql-action/upload-sarif@v4
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'
          category: 'trivy'

  comment-pr:
    name: PR ì½”ë©˜íŠ¸ ì‘ì„±
    runs-on: ubuntu-latest
    needs: [terraform-validate, tflint-scan, security-scan]
    if: always() && github.event_name == 'pull_request'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Run Terraform Plan
        id: plan
        run: |
          terraform init -backend=false
          terraform plan -no-color -out=plan.tfplan 2>&1 | tee plan_output.txt || true
        env:
          AWS_REGION: ${{ env.AWS_REGION }}
        continue-on-error: true

      - name: Format Plan Output
        id: fmt_plan
        run: |
          {
            echo "## Terraform Plan ê²€ì‚¬ ê²°ê³¼"
            echo ""
            echo "### âœ… Validate & Format Check"
            if [ "${{ needs.terraform-validate.result }}" = "success" ]; then
              echo "**Status**: í†µê³¼"
            else
              echo "**Status**: âš ï¸ ê²½ê³ "
            fi
            echo ""
            echo "### ğŸ” TFLint (ì •ì  ë¶„ì„)"
            if [ "${{ needs.tflint-scan.result }}" = "success" ]; then
              echo "**Status**: í†µê³¼"
            else
              echo "**Status**: âš ï¸ ê²½ê³ "
            fi
            echo ""
            echo "### ğŸ” Security Scan (Trivy)"
            if [ "${{ needs.security-scan.result }}" = "success" ]; then
              echo "**Status**: í†µê³¼"
            else
              echo "**Status**: âš ï¸ ê²½ê³ "
            fi
            echo ""
            echo "### ğŸ“‹ Terraform Plan Output"
            echo "\`\`\`terraform"
            head -100 plan_output.txt
            echo "\`\`\`"
            echo ""
            echo "---"
            echo "**Note**: ëª¨ë“  ê²€ì‚¬ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. PRì„ ìŠ¹ì¸í•˜ì‹¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤."
          } >> $GITHUB_STEP_SUMMARY

      - name: Comment PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');
            const planOutput = fs.readFileSync('plan_output.txt', 'utf8').substring(0, 2000);
            
            const validateStatus = '${{ needs.terraform-validate.result }}' === 'success' ? 'âœ…' : 'âš ï¸';
            const tflintStatus = '${{ needs.tflint-scan.result }}' === 'success' ? 'âœ…' : 'âš ï¸';
            const securityStatus = '${{ needs.security-scan.result }}' === 'success' ? 'âœ…' : 'âš ï¸';
            
            const comment = `## ğŸš€ Terraform Plan ê²€ì‚¬ ê²°ê³¼
            
            | ê²€ì‚¬ í•­ëª© | ìƒíƒœ |
            |---------|------|
            | Validate & Format Check | ${validateStatus} |
            | TFLint (ì •ì  ë¶„ì„) | ${tflintStatus} |
            | Security Scan (Trivy) | ${securityStatus} |
            
            ### ğŸ“‹ Plan ìš”ì•½
            \`\`\`terraform
            ${planOutput}...
            \`\`\`
            
            ëª¨ë“  ê²€ì‚¬ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. âœ¨`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
