name: terraform-plan.yml

on:
  pull_request:
    types: [opened, synchronize, reopened]
  push:
    branches:
      - main

permissions:
  contents: read
  pull-requests: write
  security-events: write

env:
  TF_VERSION: 1.6.0
  AWS_REGION: ap-northeast-2

jobs:
  terraform-validate:
    name: Validate & Format Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Terraform Format Check
        run: |
          terraform fmt -check -recursive
        continue-on-error: true

      - name: Terraform Validate
        run: |
          terraform init -backend=false
          terraform validate
        env:
          AWS_REGION: ${{ env.AWS_REGION }}

      - name: Upload validation result
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: validation-result
          path: .

  tflint-scan:
    name: TFLint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup TFLint
        uses: terraform-linters/setup-tflint@v3
        with:
          tflint_version: latest

      - name: Init TFLint
        run: |
          tflint --init

      - name: Run TFLint
        run: |
          tflint --format compact --recursive .
        continue-on-error: true

  security-scan:
    name: Security Scan (Trivy)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Trivy scan
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'config'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'
        continue-on-error: true

      - name: Upload Trivy results
        uses: github/codeql-action/upload-sarif@v4
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'
          category: 'trivy'

  comment-pr:
    name: PR 코멘트 작성
    runs-on: ubuntu-latest
    needs: [terraform-validate, tflint-scan, security-scan]
    if: always() && github.event_name == 'pull_request'
    steps:
      - name: Comment PR
        uses: actions/github-script@v6
        with:
          script: |
            const validateStatus = '${{ needs.terraform-validate.result }}' === 'success' ? '✅' : '⚠️';
            const tflintStatus = '${{ needs.tflint-scan.result }}' === 'success' ? '✅' : '⚠️';
            const securityStatus = '${{ needs.security-scan.result }}' === 'success' ? '✅' : '⚠️';
            
            const comment = `## Terraform 검사 결과
            
            | 검사 항목 | 상태 |
            |---------|------|
            | Validate & Format Check | ${validateStatus} |
            | TFLint (정적 분석) | ${tflintStatus} |
            | Security Scan (Trivy) | ${securityStatus} |
            
            > **Note**: \`terraform plan\`은 민감정보가 필요하여 로컬에서 실행해주세요.
            
            모든 검사가 완료되었습니다.`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
